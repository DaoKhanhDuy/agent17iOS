name: "Build iOS app"
on:
  push:
    branches: ["main"]

  [workflow_dispatch]

jobs:
  build_ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download Xcode project from Dropbox
        run: |
          set -xe
          wget -O archive.zip "https://www.dropbox.com/scl/fi/6ncyuvlqeq9ioqd5glndz/b5a35fc9-bfcb-11f0-a5cb-d45d64a76045.zip?rlkey=6rpzwlogfnllg6vf82o57np8e&st=7862oo23&dl=1"
          unzip -o archive.zip -d project

      - name: List schemes (for debug)
        run: |
          xcodebuild -list -project "project/Goodbye Eternity.xcodeproj"

      - name: Remove duplicate libspine_godot frameworks
        run: |
          set -xe
          find "project" -type d -name "libspine_godot.ios.template_debug.framework" | tee frameworks.txt
          # Keep only one copy (prefer the main spine_godot_extension one)
          MAIN_PATH=$(grep "spine_godot_extension/ios" frameworks.txt | head -n 1)
          echo "Keeping: $MAIN_PATH"
          while read -r path; do
            if [[ "$path" != "$MAIN_PATH" ]]; then
              echo "Removing duplicate framework: $path"
              rm -rf "$path"
            fi
          done < frameworks.txt

      - name: Build Xcode archive
        run: |
          xcodebuild archive \
            -project "project/Goodbye Eternity.xcodeproj" \
            -scheme "Goodbye Eternity" \
            -archivePath GoodbyeEternity.xcarchive \
            -configuration Release \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO

      - name: Package IPA
        run: |
          mkdir -p Payload
          mv GoodbyeEternity.xcarchive/Products/Applications/*.app Payload/
          zip -r GoodbyeEternity.ipa Payload
          mv GoodbyeEternity.ipa ${{ runner.temp }}/GoodbyeEternity.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: GoodbyeEternity
          path: ${{ runner.temp }}/GoodbyeEternity.ipa
          retention-days: 3
