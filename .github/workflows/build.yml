name: Build iOS IPA (Auto Detect)

on:
  push:
  workflow_dispatch:

env:
  # Chỉ cần đổi LINK này
  LINK: "https://my.microsoftpersonalcontent.com/personal/cfe742303ee3e675/_layouts/15/download.aspx?UniqueId=5ad4961c-375b-4649-901a-4924934531e5&Translate=false&tempauth=v1e.eyJzaXRlaWQiOiJjNzgyNGZjMS03YTY2LTQyZTMtYTgyYy1iY2FjNWE0MjA4NmYiLCJhdWQiOiIwMDAwMDAwMy0wMDAwLTBmZjEtY2UwMC0wMDAwMDAwMDAwMDAvbXkubWljcm9zb2Z0cGVyc29uYWxjb250ZW50LmNvbUA5MTg4MDQwZC02YzY3LTRjNWItYjExMi0zNmEzMDRiNjZkYWQiLCJleHAiOiIxNzY3NDY5MzgyIn0.djGaHW32FByjWlmjCUzvCW9cA-jIFNNVClp3blNEXRG66jJ4Z9_gHFynaAd5WkvnLs1idKtDFajgMPxxTziAgoxjMjsJ6MJ3UNfMH5oVqoPZhVluS4ANPpjsy4mT9-hn0-x0DUasmIRgHSMFMTZ82q3a6CxMXfWbQT735Ykro8dfTcKsWErPbC-HzzYdYILm4yaajp6oRbcmwVb4BWVEfnDvXEsy2T8E7Wp5lnNJPVKxMgEqPXcDdOuryCsqJSKFmTkcBhY2Y1ZkFTpF3mWms7i0m2y0PZPDMHhA5hLSH5BP3BuS8SV1PQMflczJzaev37lyfDK2Qey7KQOIveC-0jzaqXFWStNypbdWiTGlkY2r_qM6pQYRdQ3YlyeWGB3qmyE4IpM89PZsrPS5eNELc65Wq5CNlWxH5lueldayLl-JAkvyYbMEDZ74v1hIxkZa3s2of4LH9CQfN2_ohwWgToRlSDhz71SsQH_l5D2AF3T8Bnod0OypM0EEzK3f-k2SenqYQEpkyw4ENuN823tG9g.TLd77e8fcv5Rtr-AdL61oNVRrHH5HsjDuchjLhBK-rU&ApiVersion=2.0"

jobs:
  build_ios:
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download & unzip
        run: |
          set -xe
          curl -L --fail -o archive.zip "$LINK"
          ls -lh archive.zip
          unzip -o archive.zip -d .

          echo "=== Found workspaces/projects ==="
          find . -maxdepth 6 -name "*.xcworkspace" -print || true
          find . -maxdepth 6 -name "*.xcodeproj" -print || true

      - name: Build archive (auto detect)
        run: |
          set -xe

          WS=$(find . -maxdepth 6 -name "*.xcworkspace" -print -quit || true)
          PJ=$(find . -maxdepth 6 -name "*.xcodeproj" -print -quit || true)

          if [ -n "$WS" ]; then
            echo "✅ Using workspace: $WS"
            xcodebuild -list -workspace "$WS"
            SCHEME=$(xcodebuild -list -workspace "$WS" | awk '/Schemes:/{f=1;next} f && NF{print $1; exit}')
            echo "✅ Using scheme: $SCHEME"
            xcodebuild archive \
              -workspace "$WS" \
              -scheme "$SCHEME" \
              -archivePath build.xcarchive \
              -configuration Release \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGNING_REQUIRED=NO
          elif [ -n "$PJ" ]; then
            echo "✅ Using project: $PJ"
            xcodebuild -list -project "$PJ"
            SCHEME=$(xcodebuild -list -project "$PJ" | awk '/Schemes:/{f=1;next} f && NF{print $1; exit}')
            echo "✅ Using scheme: $SCHEME"
            xcodebuild archive \
              -project "$PJ" \
              -scheme "$SCHEME" \
              -archivePath build.xcarchive \
              -configuration Release \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGNING_REQUIRED=NO
          else
            echo "❌ No .xcworkspace/.xcodeproj found in zip"
            exit 1
          fi

      - name: Make IPA
        run: |
          set -xe
          APP_PATH=$(find "build.xcarchive/Products/Applications" -maxdepth 1 -name "*.app" -print -quit)
          if [ -z "$APP_PATH" ]; then
            echo "❌ .app not found inside archive"
            find build.xcarchive -maxdepth 6 -name "*.app" -print || true
            exit 1
          fi

          mkdir -p Payload
          mv "$APP_PATH" Payload/
          zip -r app.ipa Payload
          ls -lh app.ipa

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: iOS-IPA
          path: app.ipa
          retention-days: 3
